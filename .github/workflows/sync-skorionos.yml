name: Sync SkorionOS

on:
  # 1. å®æ—¶è§¦å‘ï¼šæ¥æ”¶æ¥è‡ª 3003n/skorionos çš„ release äº‹ä»¶
  repository_dispatch:
    types: [skorionos_release]
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šæ”¯æŒå‚æ•°åŒ–æ§åˆ¶
  workflow_dispatch:
    inputs:
      specific_tag:
        description: 'æŒ‡å®šè¦åŒæ­¥çš„ tag (å¯é€‰ï¼Œç•™ç©ºåˆ™åŒæ­¥æ‰€æœ‰æ–°ç‰ˆæœ¬)'
        required: false
        type: string
      force_resync:
        description: 'å¼ºåˆ¶é‡æ–°åŒæ­¥æ‰€æœ‰ç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
      max_releases:
        description: 'æœ€å¤§å¤„ç†çš„ release æ•°é‡'
        required: false
        type: number
        default: 10
      enable_cleanup:
        description: 'æ¸…ç†æ¨¡å¼ (auto: æ™ºèƒ½åˆ¤æ–­, true: å¼ºåˆ¶æ¸…ç†, false: ç¦ç”¨æ¸…ç†)'
        required: false
        type: choice
        options:
          - auto
          - true
          - false
        default: auto
  
  # 3. å®šæ—¶å¤‡ç”¨ï¼šæ¯å¤© UTC 02:00 æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 2 * * *'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup environment
        run: |
          # å®‰è£…å¿…è¦çš„å·¥å…·
          sudo apt-get update
          sudo apt-get install -y jq curl
          
          # è®¾ç½® Git é…ç½®
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: Determine sync parameters
        id: params
        run: |
          # æ ¹æ®è§¦å‘æ–¹å¼è®¾ç½®å‚æ•°
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "trigger_type=dispatch" >> $GITHUB_OUTPUT
            echo "specific_tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
            echo "force_resync=true" >> $GITHUB_OUTPUT
            echo "max_releases=1" >> $GITHUB_OUTPUT
            echo "enable_cleanup=false" >> $GITHUB_OUTPUT  # å®æ—¶è§¦å‘åªå¤„ç†æ–°ç‰ˆæœ¬ï¼Œä¸æ¸…ç†
            echo "ğŸ”¥ å®æ—¶è§¦å‘: å¤„ç†æ–°å‘å¸ƒçš„ç‰ˆæœ¬ ${{ github.event.client_payload.tag }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "trigger_type=manual" >> $GITHUB_OUTPUT
            echo "specific_tag=${{ github.event.inputs.specific_tag }}" >> $GITHUB_OUTPUT
            echo "force_resync=${{ github.event.inputs.force_resync }}" >> $GITHUB_OUTPUT
            echo "max_releases=${{ github.event.inputs.max_releases }}" >> $GITHUB_OUTPUT
            echo "enable_cleanup=${{ github.event.inputs.enable_cleanup }}" >> $GITHUB_OUTPUT
            echo "ğŸ¯ æ‰‹åŠ¨è§¦å‘: ç”¨æˆ·æ§åˆ¶åŒæ­¥"
          else
            echo "trigger_type=schedule" >> $GITHUB_OUTPUT
            echo "specific_tag=" >> $GITHUB_OUTPUT
            echo "force_resync=true" >> $GITHUB_OUTPUT
            echo "max_releases=30" >> $GITHUB_OUTPUT
            echo "enable_cleanup=auto" >> $GITHUB_OUTPUT  # å®šæ—¶è§¦å‘ä½¿ç”¨æ™ºèƒ½æ¸…ç†
            echo "â° å®šæ—¶è§¦å‘: æ—¥å¸¸åŒæ­¥æ£€æŸ¥"
          fi
      
      - name: Run sync script
        run: |
          chmod +x .github/scripts/sync-skorionos.sh
          .github/scripts/sync-skorionos.sh \
            "${{ steps.params.outputs.trigger_type }}" \
            "${{ steps.params.outputs.specific_tag }}" \
            "${{ steps.params.outputs.force_resync }}" \
            "${{ steps.params.outputs.max_releases }}" \
            "${{ steps.params.outputs.enable_cleanup }}"
      
      - name: Commit and push changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && git diff --cached --quiet; then
            echo "âœ¨ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          # å¤åˆ¶ skorionos ç›®å½•ä¸º sk-chimeraos ç›®å½•ï¼Œå…¼å®¹æ—§ç‰ˆæœ¬
          rm -rf sk-chimeraos
          cp -r skorionos sk-chimeraos
          
          # æ·»åŠ å˜æ›´å¹¶æäº¤
          git add skorionos/ sk-chimeraos/
          
          # ç”Ÿæˆæäº¤æ¶ˆæ¯
          trigger_type="${{ steps.params.outputs.trigger_type }}"
          specific_tag="${{ steps.params.outputs.specific_tag }}"
          
          case "$trigger_type" in
            "dispatch")
              if [[ -n "$specific_tag" ]]; then
                commit_msg="sync: add SkorionOS release $specific_tag checksums"
              else
                commit_msg="sync: add new SkorionOS release checksums"
              fi
              ;;
            "manual")
              commit_msg="sync: manual SkorionOS releases update"
              ;;
            "schedule")
              commit_msg="sync: scheduled SkorionOS releases update"
              ;;
            *)
              commit_msg="sync: update SkorionOS releases"
              ;;
          esac
          
          # æäº¤å˜æ›´
          git commit -m "$commit_msg"
          git push origin HEAD
          
          echo "ğŸš€ å˜æ›´å·²æˆåŠŸæ¨é€åˆ°ä»“åº“"
      
      - name: Summary report
        if: always()
        run: |
          echo ""
          echo "ğŸ“Š åŒæ­¥æ‰§è¡ŒæŠ¥å‘Š"
          echo "=================="
          echo "ğŸ”— è§¦å‘æ–¹å¼: ${{ steps.params.outputs.trigger_type }}"
          echo "ğŸ·ï¸  æŒ‡å®šæ ‡ç­¾: ${{ steps.params.outputs.specific_tag || 'æ— ' }}"
          echo "ğŸ”„ å¼ºåˆ¶é‡æ–°åŒæ­¥: ${{ steps.params.outputs.force_resync }}"
          echo "ğŸ“Š æœ€å¤§å¤„ç†æ•°é‡: ${{ steps.params.outputs.max_releases }}"
          echo "ğŸ§¹ æ¸…ç†æ¨¡å¼: ${{ steps.params.outputs.enable_cleanup }}"
          echo "â±ï¸  æ‰§è¡Œæ—¶é—´: $(date)"
          echo "âœ… æ‰§è¡ŒçŠ¶æ€: å®Œæˆ"
