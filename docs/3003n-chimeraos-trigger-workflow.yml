# è¿™ä¸ªæ–‡ä»¶éœ€è¦æ”¾åœ¨ 3003n/chimeraos ä»“åº“çš„ .github/workflows/ ç›®å½•ä¸‹
# æ–‡ä»¶åå»ºè®®: notify-sk-api-info.yml

name: Notify SK-API-Info on Release

on:
  release:
    types: [published]

jobs:
  notify-sk-api-info:
    runs-on: ubuntu-latest
    if: github.repository == '3003n/chimeraos'
    
    steps:
      - name: Wait for all assets upload completion
        run: |
          echo "â° ç­‰å¾…æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ..."
          release_id="${{ github.event.release.id }}"
          max_wait=900         # æœ€å¤šç­‰å¾… 15 åˆ†é’Ÿ
          wait_time=0
          check_interval=20    # æ¯ 20 ç§’æ£€æŸ¥ä¸€æ¬¡
          required_stable=2    # éœ€è¦è¿ç»­ç¨³å®šçš„æ¬¡æ•°
          stable_count=0       # å½“å‰è¿ç»­ç¨³å®šæ¬¡æ•°ï¼ˆè®¡æ•°å™¨ï¼‰
          last_asset_count=0
          
          while [ $wait_time -lt $max_wait ]; do
            echo "ğŸ” æ£€æŸ¥ release assets (å·²ç­‰å¾… ${wait_time}s)..."
            
            # è·å–å½“å‰ release çš„ assets ä¿¡æ¯
            assets_response=$(curl -s -L \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/3003n/chimeraos/releases/${release_id}")
            
            # è·å–æ‰€æœ‰ assets æ•°é‡å’Œæ€»å¤§å°
            current_asset_count=$(echo "$assets_response" | jq '.assets | length')
            total_size=$(echo "$assets_response" | jq '[.assets[].size] | add // 0')
            checksum_count=$(echo "$assets_response" | jq '[.assets[] | select(.name | startswith("sha256sum-"))] | length')
            
            echo "ğŸ“ å½“å‰æ–‡ä»¶æ•°: $current_asset_count, checksum æ–‡ä»¶: $checksum_count, æ€»å¤§å°: $total_size bytes"
            
            # æ£€æŸ¥æ–‡ä»¶æ•°é‡æ˜¯å¦ç¨³å®šï¼ˆè¿ç»­ 3 æ¬¡æ£€æŸ¥æ•°é‡ä¸å˜ï¼‰
            if [ "$current_asset_count" -eq "$last_asset_count" ]; then
              stable_count=$((stable_count + 1))
              echo "ğŸ“Š æ–‡ä»¶æ•°é‡ç¨³å®š $stable_count æ¬¡"
            else
              stable_count=0
              echo "ğŸ“ˆ æ–‡ä»¶æ•°é‡å˜åŒ–: $last_asset_count -> $current_asset_count"
            fi
            
            last_asset_count=$current_asset_count
            
            # å¦‚æœè¾¾åˆ°è¦æ±‚çš„è¿ç»­ç¨³å®šæ¬¡æ•°ï¼Œä¸”æœ‰ checksum æ–‡ä»¶ï¼Œè®¤ä¸ºä¸Šä¼ å®Œæˆ
            if [ $stable_count -ge $required_stable ] && [ $checksum_count -gt 0 ]; then
              echo "âœ… æ–‡ä»¶ä¸Šä¼ å·²ç¨³å®šï¼Œè®¤ä¸ºä¸Šä¼ å®Œæˆï¼"
              break
            fi
            
            echo "â³ æ–‡ä»¶ä¸Šä¼ å¯èƒ½ä»åœ¨è¿›è¡Œï¼Œ${check_interval}s åé‡è¯•..."
            sleep $check_interval
            wait_time=$((wait_time + check_interval))
          done
          
          if [ $wait_time -ge $max_wait ]; then
            echo "âš ï¸  ç­‰å¾…è¶…æ—¶ï¼Œä½†ä»ä¼šå°è¯•è§¦å‘åŒæ­¥ï¼ˆå¯èƒ½æ–‡ä»¶ä»åœ¨ä¸Šä¼ ï¼‰"
          else
            echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æ£€æŸ¥å®Œæˆï¼"
          fi
          
      - name: Extract release information
        id: release_info
        run: |
          echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "release_id=${{ github.event.release.id }}" >> $GITHUB_OUTPUT
          echo "release_url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.release.author.login }}" >> $GITHUB_OUTPUT
          
          # ç»Ÿè®¡ assets æ•°é‡
          assets_count=$(echo '${{ toJson(github.event.release.assets) }}' | jq '. | length')
          echo "assets_count=$assets_count" >> $GITHUB_OUTPUT
          
          # ç»Ÿè®¡ checksum æ–‡ä»¶æ•°é‡
          checksum_count=$(echo '${{ toJson(github.event.release.assets) }}' | jq '[.[] | select(.name | startswith("sha256sum-"))] | length')
          echo "checksum_count=$checksum_count" >> $GITHUB_OUTPUT
      
      - name: Log release information
        run: |
          echo "ğŸ‰ æ–°çš„ ChimeraOS release å‘å¸ƒ!"
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.release_info.outputs.tag_name }}"
          echo "ğŸ”— é“¾æ¥: ${{ steps.release_info.outputs.release_url }}"
          echo "ğŸ‘¤ å‘å¸ƒè€…: ${{ steps.release_info.outputs.author }}"
          echo "ğŸ“ Assets æ€»æ•°: ${{ steps.release_info.outputs.assets_count }}"
          echo "ğŸ”¢ Checksum æ–‡ä»¶æ•°: ${{ steps.release_info.outputs.checksum_count }}"
      
      - name: Trigger SK-API-Info sync
        run: |
          # è§¦å‘ sk-api-info ä»“åº“çš„åŒæ­¥
          curl -L -X POST \
            -H "Authorization: Bearer ${{ secrets.PAT_SK_API_INFO }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/honjow/sk-api-info/dispatches \
            -d "{
              \"event_type\": \"chimeraos_release\",
              \"client_payload\": {
                \"tag\": \"${{ steps.release_info.outputs.tag_name }}\",
                \"release_id\": \"${{ steps.release_info.outputs.release_id }}\",
                \"release_url\": \"${{ steps.release_info.outputs.release_url }}\",
                \"author\": \"${{ steps.release_info.outputs.author }}\",
                \"assets_count\": ${{ steps.release_info.outputs.assets_count }},
                \"checksum_count\": ${{ steps.release_info.outputs.checksum_count }},
                \"triggered_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
                \"source_repo\": \"3003n/chimeraos\"
              }
            }"
      
      - name: Notify completion
        if: success()
        run: |
          echo "âœ… æˆåŠŸè§¦å‘ sk-api-info ä»“åº“åŒæ­¥"
          echo "ğŸ”„ sk-api-info å°†åœ¨å‡ ç§’é’Ÿå†…å¼€å§‹å¤„ç†ç‰ˆæœ¬ ${{ steps.release_info.outputs.tag_name }}"
      
      - name: Handle failure
        if: failure()
        run: |
          echo "âŒ è§¦å‘ sk-api-info åŒæ­¥å¤±è´¥"
          echo "è¯·æ£€æŸ¥ PAT_SK_API_INFO secret æ˜¯å¦æ­£ç¡®é…ç½®"
          echo "æˆ–è€…æ‰‹åŠ¨è§¦å‘ sk-api-info ä»“åº“çš„åŒæ­¥ workflow"