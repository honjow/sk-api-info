# è¿™ä¸ªæ–‡ä»¶éœ€è¦æ”¾åœ¨ 3003n/chimeraos ä»“åº“çš„ .github/workflows/ ç›®å½•ä¸‹
# æ–‡ä»¶åå»ºè®®: notify-sk-api-info.yml

name: Notify SK-API-Info on Release

on:
  release:
    types: [published]

jobs:
  notify-sk-api-info:
    runs-on: ubuntu-latest
    if: github.repository == '3003n/chimeraos'
    
    steps:
      - name: Extract release information
        id: release_info
        run: |
          echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "release_id=${{ github.event.release.id }}" >> $GITHUB_OUTPUT
          echo "release_url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.release.author.login }}" >> $GITHUB_OUTPUT
          
          # ç»Ÿè®¡ assets æ•°é‡
          assets_count=$(echo '${{ toJson(github.event.release.assets) }}' | jq '. | length')
          echo "assets_count=$assets_count" >> $GITHUB_OUTPUT
          
          # ç»Ÿè®¡ checksum æ–‡ä»¶æ•°é‡
          checksum_count=$(echo '${{ toJson(github.event.release.assets) }}' | jq '[.[] | select(.name | startswith("sha256sum-"))] | length')
          echo "checksum_count=$checksum_count" >> $GITHUB_OUTPUT
      
      - name: Log release information
        run: |
          echo "ğŸ‰ æ–°çš„ ChimeraOS release å‘å¸ƒ!"
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.release_info.outputs.tag_name }}"
          echo "ğŸ”— é“¾æ¥: ${{ steps.release_info.outputs.release_url }}"
          echo "ğŸ‘¤ å‘å¸ƒè€…: ${{ steps.release_info.outputs.author }}"
          echo "ğŸ“ Assets æ€»æ•°: ${{ steps.release_info.outputs.assets_count }}"
          echo "ğŸ”¢ Checksum æ–‡ä»¶æ•°: ${{ steps.release_info.outputs.checksum_count }}"
      
      - name: Trigger SK-API-Info sync
        run: |
          # è§¦å‘ sk-api-info ä»“åº“çš„åŒæ­¥
          curl -L -X POST \
            -H "Authorization: Bearer ${{ secrets.PAT_SK_API_INFO }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/YOUR_USERNAME/sk-api-info/dispatches \
            -d "{
              \"event_type\": \"chimeraos_release\",
              \"client_payload\": {
                \"tag\": \"${{ steps.release_info.outputs.tag_name }}\",
                \"release_id\": \"${{ steps.release_info.outputs.release_id }}\",
                \"release_url\": \"${{ steps.release_info.outputs.release_url }}\",
                \"author\": \"${{ steps.release_info.outputs.author }}\",
                \"assets_count\": ${{ steps.release_info.outputs.assets_count }},
                \"checksum_count\": ${{ steps.release_info.outputs.checksum_count }},
                \"triggered_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
                \"source_repo\": \"3003n/chimeraos\"
              }
            }"
      
      - name: Notify completion
        if: success()
        run: |
          echo "âœ… æˆåŠŸè§¦å‘ sk-api-info ä»“åº“åŒæ­¥"
          echo "ğŸ”„ sk-api-info å°†åœ¨å‡ ç§’é’Ÿå†…å¼€å§‹å¤„ç†ç‰ˆæœ¬ ${{ steps.release_info.outputs.tag_name }}"
      
      - name: Handle failure
        if: failure()
        run: |
          echo "âŒ è§¦å‘ sk-api-info åŒæ­¥å¤±è´¥"
          echo "è¯·æ£€æŸ¥ PAT_SK_API_INFO secret æ˜¯å¦æ­£ç¡®é…ç½®"
          echo "æˆ–è€…æ‰‹åŠ¨è§¦å‘ sk-api-info ä»“åº“çš„åŒæ­¥ workflow"